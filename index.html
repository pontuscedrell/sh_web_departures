<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SL Avg√•ngar ‚Äì Flemingsberg</title>
<style>
body {
  font-family: sans-serif;
  background: #111;
  color: #fff;
  margin: 0;
  padding: 0;
  font-size: 1.8rem;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
#header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: #222;
  font-size: 1.6rem;
}
#stop-name { font-size: 2.2rem; }
#last-updated { cursor: pointer; color: #aaa; }
.tables-container {
  display: flex;
  flex: 1;
  overflow: hidden;
  gap: 1rem;
  padding: 1rem;
}
.direction-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
h2 { text-align: center; margin: 0.5rem 0; font-size: 1.6rem; }
.table-wrapper { flex: 1; overflow-y: auto; }
table { width: 100%; border-collapse: collapse; }
th, td {
  padding: 1rem 0.4rem;
  border-bottom: 2px solid #555;
  text-align: center;
}
.line {
  font-weight: bold;
  color: #fff;
  padding: 0.3rem;
  border-radius: 0.4rem;
  display: inline-block;
  min-width: 3ch;
}
.warning-icon { color: yellow; font-size: 0.8rem; margin-left: 0.2rem; }
.time { text-align: right; }
.destination-cell { width: 60%; text-align: left; }
@media (max-width: 767px) and (orientation: portrait) {
  .tables-container { flex-direction: column; }
}
</style>
</head>
<body>
  <div id="header">
    <div id="stop-name">Flemingsberg</div>
    <div id="last-updated" onclick="manualRefresh()">
      Senast uppdaterad: <span id="updated-time">-</span> (<span id="countdown">30</span>s)
      <span id="battery-status" style="margin-left:1rem;color:#aaa;">N/A</span>
    </div>
  </div>

  <div class="tables-container">
    <div class="direction-container">
      <h2>Norrg√•ende</h2>
      <div class="table-wrapper">
        <table id="north-table">
          <thead><tr><th>Linje</th><th>Destination</th><th class="time">Tid</th></tr></thead>
          <tbody><tr><td colspan="3">Laddar...</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="direction-container">
      <h2>S√∂derg√•ende</h2>
      <div class="table-wrapper">
        <table id="south-table">
          <thead><tr><th>Linje</th><th>Destination</th><th class="time">Tid</th></tr></thead>
          <tbody><tr><td colspan="3">Laddar...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// --- CONFIG ---
var currentSiteId = 9526; // Flemingsberg
var countdown = 30;
var countdownInterval;

// --- Line colors ---
function getLineColors(designation) {
  var backgroundColor = "#555";
  var textColor = "white";
  if (["40","41","42","43","44"].indexOf(designation) !== -1) backgroundColor = "#d05d9a";
  else if (["17","18","19"].indexOf(designation) !== -1) backgroundColor = "#169d4c";
  else if (["1","2","3","4"].indexOf(designation) !== -1) backgroundColor = "#008aca";
  else if (["57","74","154","164"].indexOf(designation) !== -1) backgroundColor = "#d61d23";
  return { backgroundColor: backgroundColor, textColor: textColor };
}

// --- Fetch departures (XHR) ---
function fetchDepartures() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://transport.integration.sl.se/v1/sites/" + currentSiteId + "/departures", true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        try {
          var data = JSON.parse(xhr.responseText);
          var allDeps = data.departures || [];
          var trainDeps = [];
          for (var i=0;i<allDeps.length;i++) {
            if (allDeps[i].line && allDeps[i].line.transport_mode === "TRAIN") trainDeps.push(allDeps[i]);
          }
          var northDeps = [];
          var southDeps = [];
          for (var j=0;j<trainDeps.length;j++) {
            if (trainDeps[j].direction_code === 2 && northDeps.length < 5) northDeps.push(trainDeps[j]);
            else if (trainDeps[j].direction_code === 1 && southDeps.length < 5) southDeps.push(trainDeps[j]);
          }
          updateTable("north-table", northDeps);
          updateTable("south-table", southDeps);

          var now = new Date();
          document.getElementById("updated-time").textContent = now.toLocaleTimeString();
          countdown = 30;
        } catch(e) { console.log("Fel vid parsning:", e); }
      } else {
        console.log("Fel vid h√§mtning: " + xhr.status);
      }
    }
  };
  xhr.send();
}

// --- Update table ---
function updateTable(tableId, departures) {
  var tbody = document.getElementById(tableId).getElementsByTagName("tbody")[0];
  tbody.innerHTML = "";
  if (!departures.length) {
    tbody.innerHTML = "<tr><td colspan='3'>Inga avg√•ngar</td></tr>";
    return;
  }

  for (var i=0;i<departures.length;i++) {
    var dep = departures[i];
    var colors = getLineColors(dep.line.designation);
    var cancelled = dep.state === "CANCELLED";
    var scheduledTime = new Date(dep.scheduled);
    var expectedTime = new Date(dep.expected);
    var diffMin = Math.round((expectedTime - scheduledTime)/60000);
    var delayText = "";
    if (!cancelled && (diffMin > 3 || diffMin < -2)) {
      delayText = "<span style='font-size:0.85rem;color:yellow;margin-right:4px;font-weight:bold;'>" + 
                  (diffMin>0?"+":"") + diffMin + "</span>";
    }

    var deviationBanner = "";
    if (dep.deviations && dep.deviations.length) {
      var devText = dep.deviations[0].text || "Avvikelse i trafiken";
      deviationBanner = "<div style='background:yellow;color:black;font-size:0.9rem;padding:2px 4px;margin-top:2px;border-radius:3px;'>" +
                        "‚ö†Ô∏è " + devText + "</div>";
    }

    var timeStyle = cancelled ? "color:red;text-decoration:line-through;" : "";
    var cancelledText = cancelled ? "<div style='color:red;font-size:0.8rem;font-weight:bold;'>Inst√§lld</div>" : "";

    var warn = (dep.deviations && dep.deviations.length) ? "<span class='warning-icon'>üü°</span>" : "";

    var lineText = dep.line.designation;
    while (lineText.length < 3) lineText = " " + lineText;

    var row = document.createElement("tr");
    row.innerHTML =
      "<td><span class='line' style='background:" + colors.backgroundColor + ";color:" + colors.textColor + ";'>" +
      lineText + "</span>" + warn + "</td>" +
      "<td class='destination-cell'>" + dep.destination + deviationBanner + "</td>" +
      "<td class='time'>" + cancelledText + delayText +
      "<span style='" + timeStyle + "'>" + dep.display + "</span></td>";
    tbody.appendChild(row);
  }
}

// --- Countdown + Manual refresh ---
function manualRefresh() {
  fetchDepartures();
  countdown = 30;
}

function startCountdown() {
  countdownInterval = setInterval(function() {
    countdown--;
    if (countdown <= 0) fetchDepartures();
    document.getElementById("countdown").textContent = countdown;
  }, 1000);
}

// --- Init ---
document.addEventListener("DOMContentLoaded", function() {
  fetchDepartures();
  startCountdown();
});
</script>
</body>
</html>
